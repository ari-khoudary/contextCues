---
title: "pilot results"
author: "ari khoudary"
date: '2024-08-21'
output: pdf_document
editor_options: 
  chunk_output_type: console
---

NOTE TO SELF: 
- these are the bits of code used to generate most (if not all) of the figures in my august project update.
- i started doing further analyses in this notebook but it's gotten too unwieldy and i want to preserve the old code so i'm splitting it off here
- some of the variable names might not be aligned because i changed the pipeline for loading & tidying data
- and some of the plots might not look the same as in the update presentation since i found a couple different issues with how i processed the data after the update
- that's all love u bye!


```{r load & tidy inference data}
evidence_frames <- read.csv('../data/tidied/evidenceFrames.csv')  %>% rename(respFrame = response_frame)
inference_files = list.files('../data', full.names = TRUE, pattern='block1_inference.csv', recursive = TRUE)
inference_keep_idx <- grep('excluded', inference_files, invert=T)
inference_df = do.call(rbind, lapply(inference_files[inference_keep_idx], function(x) { read.csv(x, header = TRUE)} )) 

############### tidy inference data ############### 
inferenceData_ev <- inference_df %>%
  filter(subID != 16) %>%
  rename(trueTarget = targetIdx) %>% 
  select(-c(noise1frames, noise2frames, signal1frames, block, targetImg, cue_rgb, cue_string)) %>%
  full_join(., evidence_frames, by=c('subID', 'trial', 'catch_trial', 'congruent', 'respFrame', 'response')) %>%
  mutate(accuracy = case_when(rowSums(across(c(signal1_target1, signal2_target1)), na.rm=T) > rowSums(across(c(signal1_target2, signal2_target2)), na.rm=T) & response==1 ~ 1,
                                  rowSums(across(c(signal1_target1, signal2_target1)), na.rm=T) > rowSums(across(c(signal1_target2, signal2_target2)), na.rm=T) & response==2 ~ 0,
                                  rowSums(across(c(signal1_target1, signal2_target1)), na.rm=T) < rowSums(across(c(signal1_target2, signal2_target2)), na.rm=T) & response==2 ~ 1,
                                  rowSums(across(c(signal1_target1, signal2_target1)), na.rm=T) < rowSums(across(c(signal1_target2, signal2_target2)), na.rm=T) & response==1 ~ 0),
         accuracyFactor = factor(as.character(accuracy), levels=c("0", "1", "NaN"), labels=c('correct', 'incorrect', 'NA')),
         congruent = factor(as.character(congruent), levels=c("0", "NaN", "1"), labels=c('incongruent', 'neutral', 'congruent')),
         cueIdx = case_when(trueTarget == 1 & congruent == 'congruent' ~ 1,
                            trueTarget == 1 & congruent == 'incongruent' ~ 2,
                            trueTarget == 1 & congruent == 'incongruent' ~ 2,
                            trueTarget == 2 & congruent =='congruent' ~ 2,
                            trueTarget == 2 & congruent=='incongruent' ~ 1,
                            congruent == 'neutral' ~ 3),
         respFrame = ifelse(is.na(respFrame), 540, respFrame),
         totalNoise = noise1frames_behav + noise2frames_behav,
         totalTarget1 = rowSums(across(c(signal1_target1, signal2_target1)), na.rm=T),
         totalTarget2 = rowSums(across(c(signal1_target2, signal2_target2)), na.rm=T),
         trialTarget = case_when(totalTarget1 > totalTarget2 ~ 1,
                                 totalTarget1 < totalTarget2 ~ 2,
                                 totalTarget1 == totalTarget2 ~ NA),
         trialCongruence = case_when(cueIdx == trialTarget ~ 'congruent',
                                     cueIdx != trialTarget ~ 'incongruent',
                                     totalTarget1 == totalTarget2 ~ 'equal evidence'),
         trialCongruence = factor(trialCongruence, levels=c('incongruent', 'equal evidence', 'congruent')),
         firstNoiseRT = ifelse(respFrame <= noise1frames_design, 1, 0),
         secondNoiseRT = ifelse(respFrame > (noise1frames_design+signal1frames_design) & respFrame <= (noise1frames_design+signal1frames_design+noise2frames_design),
                                1, 0),
         firstSignalRT = ifelse(respFrame > noise1frames_design & respFrame <= (noise1frames_design+signal1frames_design), 1, 0),
         secondSignalRT = ifelse(respFrame > (noise1frames_design + signal1frames_design + noise2frames_design), 1, 0),
         respPeriod = case_when(firstNoiseRT==1 ~ 'noise1',
                                firstSignalRT==1 ~ 'signal1',
                                secondNoiseRT==1 ~ 'noise2',
                                secondSignalRT==1 ~ 'signal2'), 
         cueCongChoice = case_when(cueIdx==3 ~ NA, cueIdx==response ~ 1, cueIdx!=response ~ 0),
         evCongChoice = ifelse(response==trialTarget, 1, 0),
         #firstNoise_quartile = cut(noise1frames_behav, breaks=quantile(noise1frames_behav), include.lowest = T, labels=F, na.rm=T), 
         #secondNoise_quartile = cut(noise2frames_behav, breaks=quantile(noise2frames_behav), include.lowest = T, labels=F, na.rm=T), 
         #totalNoise_quartile = cut(totalNoise, breaks=quantile(totalNoise), include.lowest = T, labels=F, na.rm=T),
         catch_trial_cat = factor(catch_trial, levels=c(0,1), labels=c('test', 'catch'))) %>%
  group_by(subID) %>%
  mutate(logRT = log(RT),
         zlogRT = scale(logRT),
         zConf = scale(confResp),
         logConfRT = log(confRT),
         zlogconfRT = scale(logConfRT), 
         rt_quartile = cut(zlogRT, breaks=quantile(zlogRT, na.rm=T), include.lowest=T, labels=F),
         trial_quartile = cut(trial, breaks=quantile(trial), include.lowest=T, labels=F)) %>%
  ungroup()
```

```{r load & tidy model data}
# load model data
modelData <- read.csv('../data/tidied/0.52coh_10_thresh_confidence.csv') 
nSubs <- 9

# tidy model data
modelData <- modelData %>%
  filter(is.na(noise1Frames)==F) %>%
  mutate(cue = factor(cue),
         threshold = factor(threshold),
         congruent = case_when(cue==0.8 & congruent==1 ~ 'congruent',
                               cue==0.8 & congruent==0 ~ 'incongruent',
                               cue==0.5 & congruent==1 ~ 'neutral',
                               cue==0.5 & congruent==0 ~ 'neutral'),
         congruent = factor(congruent, levels=c('incongruent', 'neutral', 'congruent')),
         accuracyFactor = factor(forcedChoice, levels=c(1,0), labels=c('correct', 'incorrect')),
         inverseConf = 1/accumulatorDifference,
         logInverseConf = log(inverseConf),
         flippedConf = -1*accumulatorDifference,
         respPeriod = case_when(RT <= noise1Frames ~ 1,
                                RT <= noise1Frames + signal1Frames ~ 2,
                                RT <= noise1Frames + signal1Frames + noise2Frames ~ 3,
                                RT > noise1Frames + signal1Frames + noise2Frames ~ 4),
         rt_quartile = cut(RT, quantile(RT), include.lowest=T, labels=F),
         noise1_quartile = cut(noise1Frames, quantile(noise1Frames), include.lowest=T, labels=F), 
         noise2_quartile = cut(noise2Frames, quantile(noise2Frames), include.lowest=T, labels=F),
         RT = scale(log(RT)))
```

```{r define  colors & outdir}
# define plotting colors 
colors <- c('incongruent' = "#F8766D", 'neutral' = "#00BA38", 'congruent'="#619CFF")

custom_cols <- c('incongruent' = "#F8766D", 'equal evidence' = "lemonchiffon3", 'congruent'="#619CFF")

purple <- c('strong'='darkorchid')
# where to save plots
outdir <- 'update_august/'
```

## effects of cue averaged across time: accuracy & RT
```{r static results w/o accuracy, include=F}
## model results
sim1 <- modelData %>%
  group_by(subID, congruent) %>%
  summarise(propCorrect_forced = mean(forcedChoice)) %>%
  ggplot(aes(x=congruent, y=propCorrect_forced, color=congruent, fill=congruent)) +
  geom_hline(yintercept = 0.5, linewidth=0.15) +
  stat_summary(fun = 'mean', geom = 'col', fill='white') +
  stat_summary(fun.data = 'mean_se', geom = 'errorbar', width=0.1, color='black') +
  stat_summary(fun = 'mean', geom='point', color='black') + 
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=2, alpha=0.7) +
  labs(y = 'proportion correct', x='', title='simulated') + 
  theme_classic() +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')

# plot accuracy
obs1 <- inferenceData_ev %>%
  filter(catch_trial==0) %>%
  group_by(subID, congruent) %>%
  summarise(accuracy = mean(accuracy, na.rm=T)) %>%
  ggplot(aes(x=congruent, y=accuracy, fill=congruent)) + 
  ylim(0,1) +
  theme_classic() + 
  geom_hline(yintercept=0.5, linewidth=0.15) +
  stat_summary(fun = 'mean', geom='col') +
  stat_summary(fun = 'mean', geom='point') +
  stat_summary(fun.data = 'mean_se', geom='errorbar', color='black', width=0.1) +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=2, alpha=0.7) +
  labs(title='observed - test', x='', y='proportion correct') +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')


obs1_catch <- inferenceData_ev %>%
  filter(catch_trial==1) %>%
  group_by(subID, congruent) %>%
  summarise(accuracy = mean(accuracy, na.rm=T)) %>%
  ggplot(aes(x=congruent, y=accuracy, fill=congruent)) + 
  ylim(0,1) +
  theme_classic() + 
  geom_hline(yintercept=0.5, linewidth=0.15) +
  stat_summary(fun = 'mean', geom='col') +
  stat_summary(fun = 'mean', geom='point') +
  stat_summary(fun.data = 'mean_se', geom='errorbar', color='black', width=0.1) +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=2, alpha=0.7) +
  labs(title='observed - catch', x='', y='proportion correct') +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')


############# reaction time ############# 
sim2 <- modelData %>%
  group_by(subID, congruent) %>%
  summarise(meanRT = mean(RT)) %>%
  ggplot(aes(x=congruent, y=meanRT, color=congruent, fill=congruent)) +
  geom_hline(yintercept = 0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col', fill='white') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=2, alpha=0.7) +
  labs(y = 'mean RT', x='', title='simulated') + 
  theme_classic() +
  theme(legend.position = 'none') +
  ylim(-0.5, 1) +
  geom_line(aes(group=subID), alpha=0.25, color='gray')

obs2 <- inferenceData_ev %>%
  filter(catch_trial==0) %>%
  group_by(subID, congruent) %>%
  summarise(RT = mean(zlogRT)) %>%
  ggplot(aes(x=congruent, y=RT, color=congruent, fill=congruent)) +
  geom_hline(yintercept = 0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +  
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=2, alpha=0.7) +
  labs(y = 'meanRT', x='', title='observed - test') + 
  theme_classic() +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.2, color='gray')

obs2_catch <- inferenceData_ev %>%
  filter(catch_trial==1) %>%
  group_by(subID, congruent) %>%
  summarise(RT = mean(zlogRT)) %>%
  ggplot(aes(x=congruent, y=RT, color=congruent, fill=congruent)) +
  geom_hline(yintercept = 0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +  
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=2, alpha=0.7) +
  labs(y = 'meanRT', x='', title='observed - catch') + 
  theme_classic() +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.2, color='gray')
  
```

## save plots
```{r fig1, echo=F, fig.height=4}

(sim1 + obs1 + obs1_catch) / (sim2 + obs2 + obs2_catch) & 
  theme(axis.text.x = element_text(size=12),
        axis.title.y = element_text(size=12),
        plot.title = element_text(size=14))

paste0(outdir, 'fig1.png') %>%
  ggsave(., width=10, height=6, dpi='retina')
```


## effects of cue averaged across time split by accuracy: RT
```{r make RT-accuracy plots, include=F}

sim3 <- modelData %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(meanRT = mean(RT)) %>%
  ggplot(aes(x=congruent, y=meanRT, color=congruent, fill=congruent)) +
  facet_wrap(~ accuracyFactor) + 
  geom_hline(yintercept=0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col', fill='white') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(y = 'mean RT', x='', title='simulated') + 
  theme_classic() +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray') 

obs3 <- inferenceData_test %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(meanRT = mean(zlogRT)) %>%
  ggplot(aes(x=congruent, y=meanRT, fill=congruent)) +
  theme_classic() + 
  facet_wrap(~accuracyFactor) +
  geom_hline(yintercept=0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(y = 'mean RT', x='', title='observed - test') + 
  theme_classic() +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray') +
  ylim(-0.5, 1.5)

obs3_catch <- inferenceData_catch %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(meanRT = mean(zlogRT)) %>%
  ggplot(aes(x=congruent, y=meanRT, fill=congruent)) +
  theme_classic() + 
  facet_wrap(~accuracyFactor) +
  geom_hline(yintercept=0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(y = 'mean RT', x='', title='observed - catch') + 
  theme_classic() +
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray') 
  #ylim(-0.5, 1.5)
```

## save plots
```{r makefig2 echo=FALSE, fig.height=4, warning=F}
sim3 + obs3 + obs3_catch & theme(axis.text.x = element_text(size=10),
                                      axis.title.y = element_text(size=12),
                                      plot.title = element_text(size=14))

paste0(outdir, 'fig2.png') %>%
  ggsave(., width=15, height=5, dpi='retina')
```

## effects of cue averaged across time as a function of choice accuracy: confidence
```{r make confidence plots}
##### plot raw vs. z-scored confidence ####
obs4a <- inferenceData_test %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(confidence = mean(confResp)) %>%
  ggplot(aes(x=congruent, y=confidence, fill=congruent)) +
  theme_classic() + 
  ylim(0,4) +
  facet_wrap(~accuracyFactor) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(x='', y = 'Mean confidence', title = 'test: raw confidence (1-4)') + 
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')


obs4a_catch <- inferenceData_catch %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(confidence = mean(confResp)) %>%
  ggplot(aes(x=congruent, y=confidence, fill=congruent)) +
  theme_classic() + 
  ylim(0,4) +
  facet_wrap(~accuracyFactor) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(x='', y = 'Mean confidence', title = 'catch: raw confidence (1-4)') + 
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')


obs4b <- inferenceData_test %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(zconfidence = mean(zConf)) %>%
  ggplot(aes(x=congruent, y=zconfidence, fill=congruent)) +
  theme_classic() + 
  facet_wrap(~accuracyFactor) +
  geom_hline(yintercept=0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(x='', y = 'Mean confidence', title = 'test: z-scored confidence') + 
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')

obs4b_catch <- inferenceData_catch %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(zconfidence = mean(zConf)) %>%
  ggplot(aes(x=congruent, y=zconfidence, fill=congruent)) +
  theme_classic() + 
  facet_wrap(~accuracyFactor) +
  geom_hline(yintercept=0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col') +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(x='', y = 'Mean confidence', title = 'catch: z-scored confidence') + 
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')

sim4a <- modelData %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(confidence = mean(inverseConf)) %>%
  ggplot(aes(x=congruent, y=confidence, fill=congruent, color=congruent)) +
  theme_classic() + 
  facet_wrap(~accuracyFactor) +
  geom_hline(yintercept=0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col', fill='white', linewidth=1) +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(x='', y = 'Mean confidence', title = 'model: raw confidence') + 
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')


sim4b <- modelData %>% 
  mutate(zconfidence = scale(inverseConf)) %>%
  group_by(subID, congruent, accuracyFactor) %>%
  summarise(confidence = mean(zconfidence)) %>%
  ggplot(aes(x=congruent, y=confidence, fill=congruent, color=congruent)) +
  theme_classic() + 
  facet_wrap(~accuracyFactor) +
  geom_hline(yintercept=0, linewidth=0.15) +
  stat_summary(fun='mean', geom='col', fill='white', linewidth=1) +
  stat_summary(fun.data='mean_se', geom='errorbar', width=0.1, color='black') +
  stat_summary(fun='mean', geom='point', color='black') +
  geom_point(position=position_jitterdodge(dodge.width=0.25, jitter.width = 0.15), 
             color='gray25', shape=21, size=1, alpha=0.7) +
  labs(x='', y = 'Mean confidence', title = 'model: z-scored confidence') + 
  theme(legend.position = 'none') +
  geom_line(aes(group=subID), alpha=0.25, color='gray')
```

## save plots
```{r makefig3}
(obs4a / obs4a_catch) | (obs4b / obs4b_catch) | (sim4a / sim4b) & theme(plot.title = element_text(size=16))

paste0(outdir, 'fig3.png') %>%
  ggsave(., width=15, height=8, dpi='retina')
```

## RT relative to first signal onset
```{r, fig.height=4, warning=F}
inferenceData_tidy %>%
  mutate(relativeRT = respFrame - (noise1frames+1),
         congruent = factor(congruent, levels=c('congruent', 'neutral', 'incongruent'))) %>%
  ggplot(aes(x=relativeRT/60, fill=congruent, color=congruent)) +
  facet_wrap(~ accuracyFactor) + 
  geom_histogram(bins=75, alpha=0.5) +
  geom_vline(xintercept = 0) +
  theme_classic() +
  scale_fill_manual(values=colors) +
  scale_color_manual(values=colors) +
  labs(x = 'RT (seconds)', y='# of trials')
ggsave('fig7.png', width=9, height=4.5, dpi='retina')

inferenceData_tidy %>% filter(respFrame - (noise1frames+1) < 0) %>% group_by(congruent) %>% count()
# incong total = 350; neutral total = 430; cong total = 1386
```

proportion of trials with a response made during the first noise period:
- incongruent = 20% (70/350)
- neutral = 7.7% (33/430)
- congruent = 20% (275/1386)

## does first period RT increase with first noise duration?
```{r, fig.height=4, warning=F}
inferenceData_tidy %>%
  mutate(relativeRT = respFrame - (noise1frames+1),
         pEarlyRT = ifelse(relativeRT < 0, 1, 0),
         cueType = ifelse(cueLevel != 0.5, 'strong', 'neutral')) %>%
  group_by(subID, firstNoise_quartile, congruent, cueType) %>%
  summarise(rt = mean(pEarlyRT)) %>%
  ggplot(aes(x=firstNoise_quartile, y=rt, fill=cueType, color=cueType)) +
  stat_summary(fun.data='mean_se', geom='ribbon', alpha=0.1, color=NA) + 
  stat_summary(fun = 'mean', geom='line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) + 
  theme_classic() +
  labs(y = 'p(first noise response | cue)',x='first noise quartile', title='choice bias by first noise duration') +
  geom_hline(yintercept=0.5, linewidth=0.15) +
  scale_color_manual(values = c(colors[2], purple)) +
  scale_fill_manual(values = c(colors[2], purple))

ggsave('fig8.png', width=6, height=4.5)
```

## inverse relationship between RT & confidence
```{r make inverse plot, echo=F, fig.height=5}

rtSummary_individual <- inferenceData_tidy %>%
  group_by(subID, rt_quartile, congruent, accuracyFactor) %>%
  summarise(propCorrect = mean(accuracy),
            confidence = mean(zConf))

p1 <- individualSummaryAccuracy %>%
  ggplot(aes(x=congruent, y=meanRT)) +
  facet_wrap(~ accuracyFactor) + 
  theme_classic() +
  geom_hline(yintercept=0) +
  stat_summary(aes(group=accuracyFactor, color='black'), fun = 'mean', geom='line') +
  stat_summary(fun.data = 'mean_se') +
  stat_summary(aes(y=zconfidence, group=accuracyFactor, color='gray'), fun = 'mean',
               geom='line', linetype='dashed') +
  stat_summary(aes(y=zconfidence), fun.data='mean_se',color='gray') +
  labs(y = 'z score', x = '') +
  scale_color_identity(guide = "legend",
                       name = '',
                       labels = c('RT', 'confidence')) 

conf <- rtSummary_individual %>%
  ggplot(aes(x=rt_quartile, y=confidence, color=congruent, fill=congruent, group=congruent)) +
  geom_hline(yintercept=0, linewidth=0.15) + 
  stat_summary(fun.data='mean_se', geom='ribbon', alpha=0.2, color=NA) +
  stat_summary(fun='mean', geom='line', size=1) +
  stat_summary(fun='mean', geom='point', size=2) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        text = element_text(size=14),
        legend.text = element_text(size=10)) 
```

```{r makefig4}

(p1 + conf) / (conf +  facet_wrap(~ accuracyFactor)) + plot_layout(guides = 'collect')

```

## accuracy by response period
```{r respPeriod accuracy, echo=F, fig.height=5, message=FALSE, warning=FALSE}

rtSummary_individual <- inferenceData_tidy %>%
  group_by(subID, rt_quartile, congruent) %>%
  summarise(propCorrect = mean(accuracy),
            confidence = mean(zConf))

acc <- rtSummary_individual %>%
  ggplot(aes(x=rt_quartile, y=propCorrect, color=congruent, fill=congruent, group=congruent)) +
  geom_hline(yintercept=0.5, linewidth=0.15) + 
  stat_summary(fun.data='mean_se', geom='ribbon', alpha=0.2, color=NA) +
  stat_summary(fun='mean', geom='line', linewidth=1) +
  stat_summary(fun='mean', geom='point', size=2) +
  theme_classic() +
  theme(text = element_text(size=14),
        legend.text = element_text(size=10)) +
  ggtitle('accuracy by RT quartile')

p2 <- inferenceData_tidy %>%
  group_by(subID, congruent, respPeriod) %>%
  summarise(accuracy = mean(accuracy)) %>%
  ggplot(aes(x=respPeriod, y=accuracy, color=congruent, fill=congruent)) +
  theme_classic() + geom_hline(yintercept = 0.5) +
  stat_summary(fun.data = 'mean_se', geom='ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  scale_x_continuous(labels = c('noise1', 'signal1', 'noise2', 'signal2')) +
  labs(x='', title='accuracy by response period', y='proportion correct') +
  theme(legend.position = 'none')
```

```{r respPeriod accuracy model}

p3 <- modelData %>%
  group_by(subID, congruent, rt_quartile) %>%
  summarise(propCorrect = mean(forcedChoice, na.rm=T)) %>%
  ggplot(aes(x=rt_quartile, y=propCorrect, fill=congruent, color=congruent)) +
  theme_classic() + 
  geom_hline(yintercept=0.5, linewidth=0.15) +
  stat_summary(fun.data='mean_se', geom='ribbon', color=NA, alpha=0.2) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  theme(legend.position='none') +
  labs(title = 'model prediction')


p4 <- modelData %>%
  group_by(subID, congruent, respPeriod) %>%
  filter(is.na(respPeriod)==F) %>%
  mutate(respPeriod = factor(respPeriod, levels=c(1,2,3,4), labels=c('noise1', 'signal1', 'noise2', 'signal2'))) %>%
  summarise(propCorrect = mean(forcedChoice)) %>%
  ggplot(aes(x=respPeriod, y=propCorrect, fill=congruent, color=congruent, group=congruent)) +
  theme_classic() + 
  geom_hline(yintercept=0.5, linewidth=0.15) +
  stat_summary(fun.data='mean_se', geom='ribbon', color=NA, alpha=0.2) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  theme(legend.position='none') +
  labs(title = 'model prediction')
```

```{r makefig5}

(acc + p2) / (p3 + p4) + plot_layout(guides = 'collect') & theme(text = element_text(size=12))
ggsave('fig5.png', width=12, height=7, dpi='retina')
```

## RT by response period
```{r respPeriod RT, echo=F, fig.height=5, message=F}
inferenceData_tidy %>%
  group_by(subID, congruent, respPeriod) %>%
  summarise(RT = mean(zlogRT)) %>%
  ggplot(aes(x=respPeriod, y=RT, color=congruent, fill=congruent)) +
  theme_classic() + geom_hline(yintercept = 0) +
  stat_summary(fun.data = 'mean_se', geom='ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  scale_x_continuous(labels = c('noise1', 'signal1', 'noise2', 'signal2')) +
  labs(x='', title='RT by response period', y='meanRT')
```

- also makes a lot of sense lol. kind of interesting that RTs are a hair faster for incongruent in first signal than the other conditions

## confidence by response period
```{r respPeriod confidence, echo=F, message=F, fig.height=4}
p1 <- inferenceData_tidy %>%
  group_by(subID, congruent, respPeriod) %>%
  summarise(confidence = mean(zConf)) %>%
  ggplot(aes(x=respPeriod, y=confidence, color=congruent, fill=congruent)) +
  theme_classic() + geom_hline(yintercept = 0) +
  stat_summary(fun.data = 'mean_se', geom='ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  scale_x_continuous(labels = c('noise1', 'signal1', 'noise2', 'signal2')) +
  labs(x='', title='z-confidence by response period: humans')

p2 <- modelData %>%
  mutate(inverseConf = scale(inverseConf)) %>%
  group_by(subID, congruent, respPeriod) %>%
  summarise(confidence = mean(inverseConf)) %>%
  ggplot(aes(x=respPeriod, y=confidence, color=congruent, fill=congruent)) +
  theme_classic() + geom_hline(yintercept = 0) +
  stat_summary(fun.data = 'mean_se', geom='ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1, linetype='dashed') +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  scale_x_continuous(labels = c('noise1', 'signal1', 'noise2', 'signal2')) +
  theme(legend.position = 'none') +
  labs(x='', title='z-confidence by response period: model')

p1 + p2 + plot_layout(guides = 'collect')
ggsave('fig6.png', width=10, height=5, dpi='retina')

#### try splitting up by accuracyFactor
p1 <- inferenceData_tidy %>%
  group_by(subID, congruent, respPeriod, accuracyFactor) %>%
  summarise(confidence = mean(zConf)) %>%
  ggplot(aes(x=respPeriod, y=confidence, color=congruent, fill=congruent)) +
  theme_classic() + geom_hline(yintercept = 0) +
  stat_summary(fun.data = 'mean_se', geom='ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  scale_x_continuous(labels = c('noise1', 'signal1', 'noise2', 'signal2')) +
  labs(x='', title='z-confidence by response period: humans') +
  facet_wrap(~ accuracyFactor)

p2 <- modelData %>%
  mutate(inverseConf = scale(inverseConf)) %>%
  group_by(subID, congruent, respPeriod, accuracyFactor) %>%
  summarise(confidence = mean(inverseConf)) %>%
  ggplot(aes(x=respPeriod, y=confidence, color=congruent, fill=congruent)) +
  theme_classic() + geom_hline(yintercept = 0) +
  stat_summary(fun.data = 'mean_se', geom='ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1, linetype='dashed') +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  scale_x_continuous(labels = c('noise1', 'signal1', 'noise2', 'signal2')) +
  theme(legend.position = 'none') +
  labs(x='', title='z-confidence by response period: model') +
  facet_wrap(~ accuracyFactor)

p1 / p2 + plot_layout(guides = 'collect')
ggsave('fig6_supp.png', width=10, height=10, dpi='retina')
```

- when responses are made during the first noise period, people have more confidence in those responses when the cue is informative than when it is neutral
- sharp dip in confidence for responses made during the first signal period on incongruent trials -- dovetails nicely with the finding that people are slightly faster at responding during that period for incongruent trials too


<!-- ## accuracy as a function of first noise duration -->
<!-- ```{r first noise summarise, echo=F, warning=F, fig.height=5} -->
<!-- inferenceData_tidy %>% -->
<!--   group_by(firstNoise_quartile, subID, congruent) %>% -->
<!--   summarise(accuracy = mean(accuracy)) %>% -->
<!--   ggplot(aes(x=firstNoise_quartile, y=accuracy, color=congruent, fill=congruent, group=congruent)) + -->
<!--   theme_classic() + -->
<!--   geom_hline(yintercept=0.5) + -->
<!--   stat_summary(fun.data = 'mean_se', geom = 'ribbon', alpha=0.1, color=NA) + -->
<!--   stat_summary(fun = 'mean', geom = 'line', linewidth=1) + -->
<!--   stat_summary(fun = 'mean', geom = 'point', size=2) + -->
<!--   labs(y = 'mean accuracy', x='quartile', title='accuracy by first noise duration') + -->
<!--   ylim(0, 1) -->
<!-- ``` -->

<!-- - no discernible effects of first noise duration on accuracy -->


## choice bias as a function of first noise duration
```{r, echo=FALSE, warning=F, fig.height=5}
inferenceData_tidy %>%
  filter(congruent != 'neutral') %>%
  group_by(firstNoise_quartile, subID, congruent) %>%
  summarise(congChoice = mean(congChoice)) %>%
  ggplot(aes(x=firstNoise_quartile, y=congChoice, color=congruent, fill=congruent, group=congruent)) +
  theme_classic() +
  geom_hline(yintercept=0.5) +
  stat_summary(fun.data = 'mean_se', geom = 'ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  labs(y = 'p(choose cue-dominant target | cue)', x = 'duration (seconds)', title='probability of choosing cue-dominant option as a function of first noise duration') +
  ylim(0, 1)
```


<!-- ## RT as a function of first noise duration -->
<!-- ```{r, echo=F, warning=F, fig.height=5} -->
<!-- inferenceData_tidy %>% -->
<!--   group_by(firstNoise_quartile, subID, congruent, accuracyFactor) %>% -->
<!--   summarise(RT = mean(RT)) %>% -->
<!--   ggplot(aes(x=firstNoise_quartile, y=RT, color=congruent, fill=congruent, group=congruent)) + -->
<!--   theme_classic() + -->
<!--   geom_hline(yintercept=0) + -->
<!--   stat_summary(fun.data = 'mean_se', geom = 'ribbon', alpha=0.1, color=NA) + -->
<!--   stat_summary(fun = 'mean', geom = 'line', linewidth=1) + -->
<!--   stat_summary(fun = 'mean', geom = 'point', size=2) + -->
<!--   labs(y = 'mean RT', x = 'quartile', title='RT by first noise duration') + -->
<!--   facet_wrap(~ accuracyFactor) -->
<!-- ``` -->

<!-- - no effect of first noise duration on RT -->
<!-- - but these plots are agnostic about what evidence participants actually *saw* on each trial -->
<!-- - theoretically, first noise duration should *speed* responses to cue-congruent evidence and *slow* responses to cue-incongruent evidence -->


## confidence in first noise responses as a function of first noise duration
```{r, echo=F, warning=F, fig.height=5}
inferenceData_tidy %>%
  mutate(cueType = ifelse(cueLevel != 0.5, 'strong', 'neutral')) %>%
  filter(respPeriod==1) %>%
  group_by(subID, congruent, cueType, firstNoise_quartile) %>%
  summarise(confidence = mean(zConf)) %>%
  ggplot(aes(x=firstNoise_quartile, y=confidence, color=cueType, fill=cueType, group=cueType)) +
  theme_classic() +
  geom_hline(yintercept=0) +
  stat_summary(fun.data = 'mean_se', geom = 'ribbon', alpha=0.2, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  labs(y = 'mean confidence', x = 'quartile', title='z-confidence by first noise duration') + 
  scale_color_manual(values = c(colors[2], purple)) +
  scale_fill_manual(values = c(colors[2], purple))
ggsave('fig10.png', width=6, height=4.5, dpi='retina')
```


<!-- ## accuracy as a function of second noise duration -->

```{r second noise summaries, echo=F, warning=F, fig.height=5}
inferenceData_tidy %>%
  #mutate(noise2frames = noise2frames/60) %>%
  #filter(noise2frames < 3, respPeriod < 4) %>%
  group_by(subID, congruent, secondNoise_quartile) %>%
  summarise(accuracy = mean(accuracy)) %>%
  ggplot(aes(x=secondNoise_quartile, y=accuracy, color=congruent, fill=congruent, group=congruent)) +
  theme_classic() +
  geom_hline(yintercept=0.5) +
  stat_summary(fun.data = 'mean_se', geom = 'ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  labs(y = 'mean accuracy', x='duration (seconds)', title='accuracy by second noise duration')
ggsave('fig11.png', width=6, height=4.5, dpi='retina')
```


## choice bias as a function of second noise duration
```{r, echo=FALSE, warning=F, fig.height=5}
inferenceData_tidy %>%
  #mutate(noise2frames = noise2frames/60) %>%
  #filter(noise2frames < 3) %>%
  filter(respPeriod == 3) %>%
  group_by(subID, congruent, secondNoise_quartile) %>%
  summarise(congChoice = mean(congChoice)) %>%
  ggplot(aes(x=secondNoise_quartile, y=congChoice, color=congruent, fill=congruent, group=congruent)) +
  theme_classic() +
  geom_hline(yintercept=0.5) +
  stat_summary(fun.data = 'mean_se', geom = 'ribbon', alpha=0.1, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  labs(y = 'p(choose cue-dominant target | cue)', x = 'second noise quartile', title='probability of choosing cue-dominant option as a function of second noise duration')
ggsave('fig12.png', height=4.5, width=6, dpi='retina')
```

## second noise response as a function of second noise duration
```{r}
inferenceData_tidy %>%
  mutate(cueType = ifelse(cueLevel != 0.5, 'strong', 'neutral')) %>%
  group_by(subID, secondNoise_quartile, cueType) %>%
  summarise(pResp = mean(respPeriod==3)) %>%
  ggplot(aes(x=secondNoise_quartile, y=pResp, fill=cueType, color=cueType)) +
  stat_summary(fun.data='mean_se', geom='ribbon', alpha=0.1, color=NA) + 
  stat_summary(fun = 'mean', geom='line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) + 
  theme_classic() +
  labs(y = 'p(second noise response)', x='second noise quartile') +
  geom_hline(yintercept=0.5, linewidth=0.15) +
  scale_color_manual(values = c(colors[2], purple)) +
  scale_fill_manual(values = c(colors[2], purple))
ggsave('fig13.png', width=6, height=4.5)
```

<!-- - even when the evidence is incongruent with the cue's prediction, they choose the cue-dominant image almost as frequently as they do when visual evidence is congruent with the cue's prediction -->

<!-- ## RT as a function of second noise duration -->
<!-- ```{r, echo=F, warning=F, fig.height=5} -->
<!-- inferenceData_tidy %>% -->
<!--   mutate(noise2frames = noise2frames/60) %>% -->
<!--   filter(noise2frames < 3) %>% -->
<!--   ggplot(aes(x=noise2frames, y=zlogRT, color=congruent, fill=congruent, group=congruent)) + -->
<!--   theme_classic() + -->
<!--   geom_hline(yintercept=0) + -->
<!--   #stat_summary_bin(fun.data = 'mean_se', fun.args = list(mult=nSubs), geom = 'ribbon', bins=nBin, alpha=0.1, color=NA) + -->
<!--   stat_summary_bin(fun = 'mean', geom = 'line', bins=nBin, linewidth=1) + -->
<!--   stat_summary_bin(fun = 'mean', geom = 'point', bins=nBin, size=2) + -->
<!--   scale_x_continuous(n.breaks=nBin) + -->
<!--   labs(y = 'mean RT', x = 'duration (seconds)', title='RT by second noise duration (all responses)') +  -->
<!--   facet_wrap(~ accuracyFactor) -->
<!-- ``` -->

<!-- - here is where we start to see the accuracy interaction: incongruent cues slow correct RTs and speed incorrect RTs -->

## confidence as a function of second noise duration
```{r, echo=F, warning=F, fig.height=5}
inferenceData_tidy %>%
  filter(respPeriod==3) %>%
  group_by(subID, congruent, secondNoise_quartile, accuracyFactor) %>%
  summarise(zConf = mean(zConf)) %>%
  ggplot(aes(x=secondNoise_quartile, y=zConf, color=congruent, fill=congruent, group=congruent)) +
  theme_classic() +
  geom_hline(yintercept=0) +
  stat_summary(fun.data = 'mean_se', geom = 'ribbon', alpha=0.2, color=NA) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun = 'mean', geom = 'point', size=2) +
  labs(y = 'mean confidence', x = 'second noise quartile', title='z-confidence for second noise responses') +
  facet_wrap(~ accuracyFactor)

ggsave('fig14.png', width=8, height=4.5)
```

## behavior across the expt
```{r}
trial_quartile <- quantile(inferenceData_tidy$trial, names=F)
inferenceData_tidy <- inferenceData_tidy %>%
  mutate(trial_quartile = case_when(trial <= trial_quartile[1] ~ 1,
                                    trial > trial_quartile[1] & trial <= trial_quartile[2] ~ 2,
                                    trial > trial_quartile[2] & trial <= trial_quartile[3] ~ 3,
                                    trial > trial_quartile[3] & trial <= trial_quartile[4] ~ 4))

inferenceData_tidy %>%
  group_by(subID, congruent, trial_quartile) %>%
  summarise(pFirstResp = mean(respPeriod==1)) %>%
  ggplot(aes(x=trial_quartile, y=pFirstResp, color=congruent, fill=congruent)) +
  theme_classic() + 
  geom_hline(yintercept = 0.5, linewidth=0.15) + 
  stat_summary(fun.data='mean_se', geom = 'ribbon', color=NA, alpha=0.2) + 
  stat_summary(fun = 'mean', geom = 'line', linewidth=1) +
  stat_summary(fun= 'mean', geom = 'point', size=2)
ggsave('fig15.png', width=5, height=4.5)

```



#### calibration results #### 
```{r}
calibration_files = list.files('../data', full.names = TRUE, pattern='block1_calibration.csv', recursive = TRUE)
calibration_keep_idx <- grep('excluded', calibration_files, invert=T)
calibration_df = do.call(rbind, lapply(calibration_files[calibration_keep_idx], function(x) { read.csv(x, header = TRUE)} )) 

calibration_df %>%
  filter(subID != 16) %>%
  ggplot(aes(x=trial, y=coherence, color=factor(targetIdx))) +
  facet_wrap(~ subID, nrow=2) +
  theme_bw() +
  geom_line() +
  labs(title = 'staircased coherences for each target') +
  theme(text = element_text(size=14))

paste0(outdir, 'calibration.png') %>% ggsave(width=14, height=8, dpi='retina')

### calibrated coherences
inferenceData_tidy <- read.csv('../data/tidied/inference_data_wrongNoiseInfo.csv')
inferenceData_tidy %>%
  filter(subID != 16) %>%
  ggplot(aes(x=factor(subID), y=coherence, color=factor(targetIdx), fill=factor(targetIdx))) +
  geom_point(position = position_dodge(width=0), size=4) + 
  ylim(0.6, 0.8) +
  theme_bw() +
  labs(title = 'calibrated coherence for each target image', subtitle='note truncated y-axis')
paste0(outdir, 'calibratedCoherence.png') %>% ggsave(width=6, height=4, dpi='retina')
```

#### learning results #### 
```{r}
learningData <- read.csv('../data/tidied/learning_data.csv')

learningData %>%
  mutate(congruent = factor(congruent, levels=c('incongruent', 'neutral', 'congruent'))) %>%
  group_by(subID, congruent, learning_quartile) %>%
  summarise(meanRT = mean(zlogRT)) %>%
  ggplot(aes(x=learning_quartile, y=meanRT, color=congruent, fill=congruent, group=congruent)) +
  geom_hline(yintercept = 0, linewidth=0.15) +
  stat_summary(fun.data = 'mean_se', geom = 'ribbon', color=NA, alpha=0.1) +
  stat_summary(fun = 'mean', geom = 'line', linewidth=1.5) +
  theme_classic() +
  labs(y='mean RT', x='trial quartile', title='RTs over the course of cue learning')

paste0(outdir, 'learnRTs.png') %>% ggsave(width=6, height=4, dpi='retina')
```